--// LocalScript: Platform Builder (Compact GUI with proper Minimize, Trash, and Stop Button)

--// Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

--// Player
local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")

--// Remote
local buildRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("BuildRequest")

--// GUI Setup
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "PlatformGUI"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 220, 0, 150)
frame.Position = UDim2.new(0.5, -110, 0.5, -75)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true

--// Buttons
local close = Instance.new("TextButton", frame)
close.Size = UDim2.new(0, 20, 0, 20)
close.Position = UDim2.new(1, -25, 0, 5)
close.Text = "X"
close.TextColor3 = Color3.new(1, 0, 0)
close.BackgroundColor3 = Color3.fromRGB(80, 0, 0)
close.Font = Enum.Font.SourceSansBold
close.TextSize = 14
close.MouseButton1Click:Connect(function() gui:Destroy() end)

local minimizeBtn = Instance.new("TextButton", frame)
minimizeBtn.Size = UDim2.new(0, 20, 0, 20)
minimizeBtn.Position = UDim2.new(1, -50, 0, 5)
minimizeBtn.Text = "_"
minimizeBtn.TextColor3 = Color3.new(1,1,1)
minimizeBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
minimizeBtn.Font = Enum.Font.SourceSansBold
minimizeBtn.TextSize = 14

local trashBtn = Instance.new("TextButton", frame)
trashBtn.Size = UDim2.new(0,20,0,20)
trashBtn.Position = UDim2.new(1,-75,0,5)
trashBtn.Text = "üóëÔ∏è"
trashBtn.TextColor3 = Color3.new(1,1,1)
trashBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
trashBtn.Font = Enum.Font.SourceSansBold
trashBtn.TextSize = 14
trashBtn.MouseButton1Click:Connect(function()
	local destroyRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("DestroyAllBuilds")
	destroyRemote:FireServer()
end)

-- Stop Spawning Button
local stopSpawnBtn = Instance.new("TextButton", frame)
stopSpawnBtn.Size = UDim2.new(0,20,0,20)
stopSpawnBtn.Position = UDim2.new(1,-100,0,5)
stopSpawnBtn.Text = "‚èπÔ∏è"
stopSpawnBtn.TextColor3 = Color3.new(1,1,1)
stopSpawnBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
stopSpawnBtn.Font = Enum.Font.SourceSansBold
stopSpawnBtn.TextSize = 14

--// GUI Labels and Boxes
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,-130,0,25)
title.Position = UDim2.new(0,10,0,5)
title.BackgroundTransparency = 1
title.Text = "Platform Builder"
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left

local sizeLabel = Instance.new("TextLabel", frame)
sizeLabel.Size = UDim2.new(0.9,0,0,15)
sizeLabel.Position = UDim2.new(0.05,0,0.2,0)
sizeLabel.BackgroundTransparency = 1
sizeLabel.Text = "Size (Width x Length):"
sizeLabel.TextColor3 = Color3.new(1,1,1)
sizeLabel.Font = Enum.Font.SourceSans
sizeLabel.TextSize = 14

local sizeBox = Instance.new("TextBox", frame)
sizeBox.Size = UDim2.new(0.9,0,0,25)
sizeBox.Position = UDim2.new(0.05,0,0.33,0)
sizeBox.BackgroundColor3 = Color3.fromRGB(60,60,60)
sizeBox.TextColor3 = Color3.new(1,1,1)
sizeBox.PlaceholderText = "9x9"
sizeBox.Font = Enum.Font.SourceSans
sizeBox.TextSize = 16
sizeBox.ClearTextOnFocus = false
sizeBox.Text = "9x9"

local markButton = Instance.new("TextButton", frame)
markButton.Size = UDim2.new(0.9,0,0,30)
markButton.Position = UDim2.new(0.05,0,0.53,0)
markButton.Text = "Mark Area"
markButton.Font = Enum.Font.SourceSans
markButton.TextSize = 14
markButton.BackgroundColor3 = Color3.fromRGB(0,120,255)
markButton.TextColor3 = Color3.new(1,1,1)

local placeButton = Instance.new("TextButton", frame)
placeButton.Size = UDim2.new(0.9,0,0,30)
placeButton.Position = UDim2.new(0.05,0,0.75,0)
placeButton.Text = "Place Platform"
placeButton.Font = Enum.Font.SourceSans
placeButton.TextSize = 14
placeButton.BackgroundColor3 = Color3.fromRGB(0,200,100)
placeButton.TextColor3 = Color3.new(1,1,1)

--// Variables
local minimized = false
local markedPos = nil
local markerPart = nil
local tileSize = 4
local spawningActive = true
local yIncrement = 0

--// Helper: Parse size
local function getPlatformSize()
	local text = sizeBox.Text:lower()
	local width,length = text:match("(%d+)%s*x%s*(%d+)")
	width = tonumber(width) or 9
	length = tonumber(length) or width
	return math.clamp(width,1,999), math.clamp(length,1,999)
end

--// Minimize logic
local elementsToHide = {title,sizeLabel,sizeBox,markButton,placeButton}
minimizeBtn.MouseButton1Click:Connect(function()
	minimized = not minimized
	if minimized then
		for _,el in pairs(elementsToHide) do el.Visible=false end
		frame.Size = UDim2.new(0,105,0,25)
		close.Position = UDim2.new(1,-25,0,2)
		minimizeBtn.Position = UDim2.new(1,-50,0,2)
		trashBtn.Position = UDim2.new(1,-75,0,2)
		stopSpawnBtn.Position = UDim2.new(1,-100,0,2)
	else
		for _,el in pairs(elementsToHide) do el.Visible=true end
		frame.Size = UDim2.new(0,220,0,150)
		close.Position = UDim2.new(1,-25,0,5)
		minimizeBtn.Position = UDim2.new(1,-50,0,5)
		trashBtn.Position = UDim2.new(1,-75,0,5)
		stopSpawnBtn.Position = UDim2.new(1,-100,0,5)
	end
end)

---------------------------------------------------------------------
-- Mark Area (CAMERA-BASED, aligned perfectly)
---------------------------------------------------------------------
markButton.MouseButton1Click:Connect(function()
	spawningActive = true
	if markerPart then markerPart:Destroy() end

	local char = player.Character or player.CharacterAdded:Wait()
	local hrp = char:WaitForChild("HumanoidRootPart")
	local cam = workspace.CurrentCamera

	local width,length = getPlatformSize()
	local totalX = width*tileSize
	local totalZ = length*tileSize

	local forward = cam.CFrame.LookVector
	forward = Vector3.new(forward.X,0,forward.Z)
	if forward.Magnitude==0 then forward=Vector3.new(0,0,-1) end
	forward = forward.Unit

	-- Place marker directly in front of player at a fixed distance
	local distanceInFront = 10 -- Fixed distance from player
	local targetPos = hrp.Position + forward * distanceInFront

	markedPos = Vector3.new(
		math.floor(targetPos.X/tileSize+0.5)*tileSize,
		hrp.Position.Y-(hrp.Size.Y/2)-3,
		math.floor(targetPos.Z/tileSize+0.5)*tileSize
	)

	markerPart = Instance.new("Part")
	markerPart.Anchored = true
	markerPart.Size = Vector3.new(totalX,1,totalZ)
	markerPart.Position = markedPos + Vector3.new(0,0.5,0)
	markerPart.Color = Color3.fromRGB(0,255,0)
	markerPart.Transparency = 0.4
	markerPart.Material = Enum.Material.Neon
	markerPart.CanCollide = false
	markerPart.Parent = workspace
end)

----------------------
-- Stop Spawning
----------------------
stopSpawnBtn.MouseButton1Click:Connect(function()
	spawningActive=false
	if markerPart then markerPart:Destroy() markerPart=nil end
	markedPos=nil
end)

---------------------------------------------------------------------
-- Place Platform (floor only)
---------------------------------------------------------------------
placeButton.MouseButton1Click:Connect(function()
	if not markedPos then
		warn("No marked area!")
		return
	end

	local width, length = getPlatformSize()

	-- reset spawningActive
	spawningActive = true

	-- spawn floor tiles
	for x = 0, width - 1 do
		for z = 0, length - 1 do
			if not spawningActive then
				if markerPart then markerPart:Destroy() markerPart = nil end
				markedPos = nil
				return
			end

			local offsetX = (x - (width - 1) / 2) * tileSize
			local offsetZ = (z - (length - 1) / 2) * tileSize

			local pos = Vector3.new(
				markedPos.X + offsetX,
				markedPos.Y + 0.6 + yIncrement,
				markedPos.Z + offsetZ
			)

			buildRemote:InvokeServer("Metal Sheet", CFrame.new(pos), workspace:WaitForChild("Surface"))
			task.wait(0.04)
		end
	end

	-- cleanup marker
	if markerPart then
		markerPart:Destroy()
		markerPart = nil
	end
	markedPos = nil
	
	-- Increment Y for next placement
	yIncrement = yIncrement + 0.0001
end)

--------------------
--// Close GUI
--------------------
close.MouseButton1Click:Connect(function()
	gui:Destroy()
end)
